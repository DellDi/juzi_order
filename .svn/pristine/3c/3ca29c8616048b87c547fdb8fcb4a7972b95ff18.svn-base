// pages/home/home.js
const app = getApp();
Page({
  /**
   * 页面的初始数据
   */
  data: {
    show: "",
    city: "",
    today: {},
    future: {},
    index:0,
    // selectShop: true,
    // firstShop: '',
    // selectArea: false,
    // shop_name: [],
    indicatorDots: true,
    autoplay: true,
    interval: 3000,
    duration: 1000,
    latitude:'',
    longitude:'',
    openid: '',
    selectPerson: true,
    firstPerson: '',
    selectArea: false,
  },
  //点击选择类型
  clickPerson: function () {
    var selectPerson = this.data.selectPerson;
    if (selectPerson == true) {
      this.setData({
        selectArea: true,
        selectPerson: false,
      })
    } else {
      this.setData({
        selectArea: false,
        selectPerson: true,
      })
    }
  },

  //点击切换
  mySelect: function (e) {
    var page=this;
    wx.request({
      url: getApp().globalData.domain + 'Index/get_shopid',
      method: 'GET',
      data: { shop_name: e.target.dataset.me },
      header: {
        'Accept': 'application/json'
      },
      success: function (res) {
        wx.setStorageSync('shopid', res.data.shopid)
        page.get_lunbo();
        page.get_latest_order();
        page.get_menu();
        page.setData({
          firstPerson: e.target.dataset.me,
          selectPerson: true,
          selectArea: false,
        })
        // wx.getStorageSync('shopid') 
      }
    });
    
  },
  
  
loadInfo(){
  var page = this;
  wx.getLocation({
    type: 'gcj02',
    success: function (res) {
      page.data.latitude = res.latitude
      page.data.longitude = res.longitude
      wx.setStorageSync('latitude', res.latitude)
      wx.setStorageSync('longitude', res.longitude)
      page.loadCity(page.data.latitude, page.data.longitude);
    }
  })
},
loadCity: function(latitude, longitude){
  var page = this;
  wx.request({
    url: 'http://api.map.baidu.com/geocoder/v2/?ak=ZWSa6lNYb7Mflal9FZvA0cOc7ox9CliU&location=' + latitude + ',' + longitude + '&output=json',
    header: {
      'Conyent-Type': 'application/json'
    },
    success: function (res) {
      console.log(res)
      wx.setStorageSync('currentaddress', res.data.result.formatted_address);
    
      var city = res.data.result.addressComponent.city;
      city = city.replace("市", "");
      page.setData({ city: city });
      page.loadWeather(city);
      page.get_lunbo();
      page.get_latest_order();
      page.get_menu();
      page.get_shop_info();
    }
  });
},
loadWeather: function(city) {
  var page = this;
  wx.request({
    url: 'http://wthrcdn.etouch.cn/weather_mini?city=' + city,
    header: {
      'Conyent-Type': 'application/json'
    },
    success: function (res) {
      var future = res.data.data.forecast;
      var todayInfo = future.shift();
      var today = res.data.data;
      today.todayInfo = todayInfo;
      page.setData({ today: today, future: future })
    }
  })
  },
onLoad: function (options) {
    this.loadInfo();
    var page = this;
    // page.setData({
    //   openid: app.globalData.openid,
    // })
    var domain=getApp().globalData.domain;
    page.get_lunbo();
    page.get_latest_order();
    page.get_menu();
    page.get_shop_info();  
},
get_lunbo:function(){
  var page = this;
  wx: wx.request({
    url: getApp().globalData.domain + 'Index/get_lunbo',
    // method: 'post',
    // header: { 'content-type': 'application/x-www-form-urlencoded; ' },
    method: 'GET',
    data: { shopid: wx.getStorageSync('shopid') },
    header: {
      'Accept': 'application/json'
    },
    success: function (res) {
      page.setData({
        image: res.data
      })

    },
    fail: function (res) { },
    complete: function (res) { },
  })
}
,
get_menu:function(){
  var page = this;
  wx: wx.request({
    url: getApp().globalData.domain + 'Index/menu_push',
    method: 'GET',
    data: { shopid: wx.getStorageSync('shopid') },
    header: {
      'Accept': 'application/json'
    },
    // header: { "Content-Type": "application/x-www-form-urlencoded" },
    success: function (res) {
      page.setData({
        menu_push: res.data.menu_push
      })

    },
    fail: function (res) { },
    complete: function (res) { },
  })
}
,
get_latest_order:function(){
    var page = this;
    wx: wx.request({
      url: getApp().globalData.domain + 'Index/get_latest_order',
      method: 'GET',
      data: { openid: wx.getStorageSync('openid') },
      header: {
        'Accept': 'application/json'
      },
      success: function (res) {
        page.setData({
          latest_order: res.data
        })
      },
      fail: function (res) { },
      complete: function (res) { },
    })
  
  },
get_shop_info:function(){
  var page = this;
    wx: wx.request({
      url: getApp().globalData.domain + 'Index/get_shop_info',
      method: 'GET',
      data: { latitude: wx.getStorageSync('latitude'), longitude: wx.getStorageSync('longitude'), openid: wx.getStorageSync('openid') },
      header: {
        'Accept': 'application/json'
      },
      success: function (res) {
        //  console.log(res)
        page.setData({
          shop_name: res.data,
          firstPerson: res.data[0].shop_name
        })
        wx.setStorageSync('shopid', res.data[0].id)

      },
      fail: function (res) { },
      complete: function (res) { },
    })
  
},
  previewImage: function (e) {
    var current = e.target.dataset.src;
    wx.previewImage({
      current: current,
      urls: this.data.image,
    })

  },
  // 
  bindPickerChange: function (e) {
    this.setData({
      index: e.detail.value
    })
  },
  click: function () {
    var that = this;
    var show;
    wx.scanCode({
      success: (res) => {
        wx.showToast({
          title: '成功',
          icon: 'success',
          duration: 2000
        })
      },
      fail: (res) => {
        wx.showToast({
          title: '失败',
          icon: 'success',
          duration: 2000
        })
      },
      complete: (res) => { }
    })
  },
  onShareAppMessage: function () {

  },
  onShow: function () {
   
  }
  



})